version: 2
jobs:
  setup:
    docker:
      - image: circleci/android:api-25-ndk-r17b
    steps:
      - checkout
      - run: pwd
      - run:
          name: Workspace TryOuts
          command: |
            mkdir /home/circleci/project/Landroid
            echo "ls -la /home/circleci/project/*"
            ls -la /home/circleci/project/*
            echo "Trying out workspaces" > /home/circleci/project/Landroid/workspace_echo
      - run:
          name: Setup the Environment using Scripts by Akhilnarang
          command: |
            mkdir toolz && cd toolz
            git clone https://github.com/akhilnarang/scripts
            cd scripts
            bash setup/android_build_env.sh
            bash setup/install_android_sdk.bash
            cd ../../ && rm -rf toolz
            echo ">>> Initial Disc Space is" && df -hlT
          no_output_timeout: 3m
      - persist_to_workspace:
          root: .
          #paths:
          #  - ~/Landroid
  build:
    docker:
      - image: circleci/android:api-25-ndk-r17b
    steps:
      - checkout
      - run: sleep 90
      - attach_workspace:
          at: .
      - run: |
          ls -la ../
          if [[ $(cat /home/circleci/project/Landroid/workspace_echo) == "Trying out workspaces" ]]; then
            echo "It worked!";
          else
            echo "Nope! Workspaces test Failed!";
          fi
      - run:
          name: Git Config and Get LineageOS
          command: |
            cd /home/circleci/project/Landroid
            # Github Authorization
            git config --global user.email $GitHubMail
            git config --global user.name $GitHubName
            git config --global color.ui true
            # Install the repo again (failsafe)
            echo "Installing repo"
            sudo curl --create-dirs -L -o /usr/local/bin/repo -O -L https://github.com/akhilnarang/repo/raw/master/repo
            sudo chmod a+x /usr/local/bin/repo
            # Initialize the repo data fetching
            repo init -q -u https://github.com/LineageOS/android.git -b cm-14.1 --depth 1
            # Add device sources in local_manifest
            wget -q 'https://gist.githubusercontent.com/rokibhasansagar/c65b9b7f9564bd9d70084c68719b292a/raw/18fff97243a7e4b7de476e47cc569c10ad8d1279/doogee_x5-local_manifest.xml' -P .repo/local_manifests
            # Sync it up!
            sudo repo sync -c -f -q --force-sync --no-clone-bundle --no-tags -j36
            # Own the files
            sudo chown -R circleci /home/circleci/project/Landroid/*
            # Patch
            cd device/doogee/x5/patches
            bash do.sh
            cd /home/circleci/Landroid
            # How much space is taken?
            echo ">>> How much space taken by .repo?" && du -sh .repo/
            echo ">>> How much space taken by checked-out files?" && du -sh /home/circleci/project/Landroid
            echo ">>> Primary Disc Space is now --- " && df -hlT
            ls -la .
          no_output_timeout: 5m
      - run:
          name: Set 40 Gigs of CCache
          command: |
            cd /home/circleci/project/Landroid
            ./prebuilts/sdk/tools/jack-admin kill-server
            export ANDROID_JACK_VM_ARGS="-Xmx3g -XX:+TieredCompilation -Dfile.encoding=UTF-8"
            export SERVER_NB_COMPILE=2
            export ANDROID_JACK_VM_ARGS=$JACK_SERVER_VM_ARGUMENT
            ./prebuilts/sdk/tools/jack-admin start-server
            sudo apt install whiptail wput -qqy
            echo "export USE_CCACHE=1" >> ~/.bashrc
            echo "export CCACHE_COMPRESS=1" >> ~/.bashrc
            . ~/.bashrc
            ccache -M 40G
            ccache -C
      - run:
          name: Build the LineageOS
          command: |
            cd /home/circleci/project/Landroid
            echo "Environment Setup"
            . build/envsetup.sh
            echo "Lunching --- "
            lunch lineage_x5-userdebug
            sleep 2
            echo "Brunching, Umm.. --- "
            brunch lineage_x5-userdebug
          no_output_timeout: 50m
      - run:
          name: Upload Resulting Files
          command: |
            cd /home/circleci/project/Landroid
            cd out/target/product/x5/
            # list all the files
            ls -la */
            # upload
            for file in *; do wput $file ftp://"$FTPUser":"$FTPPass"@"$FTPHost"//TestLAndroid/Doogee_X5/ ; done
          no_output_timeout: 10m
    
workflows:
  version: 2
  setup_and_build:
    jobs:
      - setup
      - build
